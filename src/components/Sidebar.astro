---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import FormattedDate from './FormattedDate.astro';

const posts = await getCollection('blog');

// Build category map with post counts
const categoryMap = new Map<string, number>();
posts.forEach(post => {
	if (post.data.categories) {
		post.data.categories.forEach(category => {
			const categoryLower = category.toLowerCase();
			categoryMap.set(categoryLower, (categoryMap.get(categoryLower) || 0) + 1);
		});
	}
});

// Sort categories by post count (descending)
const sortedCategories = Array.from(categoryMap.entries())
	.sort((a, b) => b[1] - a[1]);

// Get featured posts
const featuredPosts = posts
	.filter(post => post.data.categories?.some(cat => cat.toLowerCase() === 'featured'))
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 3);

// Get recent posts
const recentPosts = posts
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 5);
---

<aside class="sidebar">
	<!-- Recent Posts -->
	<div class="sidebar-section">
		<h3>Recent Posts</h3>
		<div class="recent-posts">
			{recentPosts.map((post) => (
				<div class="recent-post">
					<a href={`/${post.id}/`} class="recent-post-link">
						{post.data.heroImage && (
							<Image 
								width={80} 
								height={80} 
								src={post.data.heroImage} 
								alt={post.data.title}
								class="recent-post-thumbnail"
							/>
						)}
						<div class="recent-post-content">
							<h4 class="recent-post-title">{post.data.title}</h4>
							<div class="recent-post-meta">
								{post.data.categories && post.data.categories.length > 0 && (
									<span class="recent-post-category">
										{post.data.categories[0]}
									</span>
								)}
								<span class="recent-post-date">
									<FormattedDate date={post.data.pubDate} />
								</span>
							</div>
						</div>
					</a>
				</div>
			))}
		</div>
	</div>

	<!-- Category Map -->
	<div class="sidebar-section">
		<h3>Categories</h3>
		<ul class="category-list">
			{sortedCategories.map(([category, count]) => (
				<li>
					<a href={`/category/${category}/`}>
						<span class="category-name">{category}</span>
						<span class="category-count">({count})</span>
					</a>
				</li>
			))}
		</ul>
	</div>

	<!-- Featured Posts -->
	{featuredPosts.length > 0 && (
		<div class="sidebar-section">
			<h3>Featured Posts</h3>
			<div class="featured-posts">
				{featuredPosts.map((post) => (
					<a href={`/${post.id}/`} class="featured-post">
						{post.data.heroImage && (
							<Image 
								width={300} 
								height={150} 
								src={post.data.heroImage} 
								alt={post.data.title}
								class="featured-thumbnail"
							/>
						)}
						<div class="featured-content">
							<h4>{post.data.title}</h4>
							<p class="featured-date">
								<FormattedDate date={post.data.pubDate} />
							</p>
						</div>
					</a>
				))}
			</div>
		</div>
	)}
</aside>

<style>
	.sidebar {
		width: 100%;
	}

	.sidebar-section {
		background: white;
		border: 1px solid rgb(var(--gray-light));
		border-radius: 8px;
		padding: 1.5em;
		margin-bottom: 2em;
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
	}

	.sidebar-section h3 {
		margin: 0 0 1em 0;
		font-size: 1.25rem;
		color: rgb(var(--gray-dark));
		border-bottom: 2px solid var(--accent);
		padding-bottom: 0.5em;
	}

	.category-list {
		list-style: none;
		margin: 0;
		padding: 0;
	}

	.category-list li {
		margin-bottom: 0.75em;
	}

	.category-list a {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 0.5em;
		border-radius: 4px;
		text-decoration: none;
		color: rgb(var(--gray-dark));
		transition: all 0.2s ease;
	}

	.category-list a:hover {
		background-color: rgb(var(--gray-light));
		color: var(--accent);
		padding-left: 1em;
	}

	.category-name {
		font-weight: 500;
		text-transform: capitalize;
	}

	.category-count {
		color: rgb(var(--gray));
		font-size: 0.9em;
	}

	.featured-posts {
		display: flex;
		flex-direction: column;
		gap: 1.5em;
	}

	.featured-post {
		text-decoration: none;
		color: rgb(var(--gray-dark));
		display: block;
		transition: all 0.2s ease;
		border-radius: 4px;
		overflow: hidden;
	}

	.featured-post:hover {
		transform: translateX(4px);
	}

	.featured-post :global(.featured-thumbnail) {
		width: 100%;
		height: 150px;
		object-fit: cover;
		border-radius: 4px;
		margin-bottom: 0.5em;
	}

	.featured-content h4 {
		margin: 0 0 0.5em 0;
		font-size: 1rem;
		line-height: 1.3;
		color: rgb(var(--gray-dark));
	}

	.featured-post:hover .featured-content h4 {
		color: var(--accent);
	}

	.featured-date {
		margin: 0;
		font-size: 0.875rem;
		color: rgb(var(--gray));
	}

	.recent-posts {
		display: flex;
		flex-direction: column;
		gap: 1.25em;
	}

	.recent-post {
		padding-bottom: 1.25em;
		border-bottom: 1px solid rgb(var(--gray-light));
	}

	.recent-post:last-child {
		border-bottom: none;
		padding-bottom: 0;
	}

	.recent-post-link {
		display: flex;
		gap: 1em;
		text-decoration: none;
		color: rgb(var(--gray-dark));
		transition: all 0.2s ease;
	}

	.recent-post-link:hover {
		transform: translateX(2px);
	}

	.recent-post-link :global(.recent-post-thumbnail) {
		width: 80px;
		height: 80px;
		object-fit: cover;
		border-radius: 6px;
		flex-shrink: 0;
	}

	.recent-post-content {
		flex: 1;
		display: flex;
		flex-direction: column;
		justify-content: center;
		gap: 0.5em;
	}

	.recent-post-title {
		font-weight: 600;
		font-size: 0.9rem;
		line-height: 1.3;
		color: rgb(var(--gray-dark));
		margin: 0;
		transition: color 0.2s ease;
	}

	.recent-post-link:hover .recent-post-title {
		color: var(--accent);
	}

	.recent-post-meta {
		display: flex;
		flex-direction: column;
		gap: 0.25em;
		font-size: 0.75rem;
	}

	.recent-post-category {
		display: inline-block;
		padding: 0.2em 0.4em;
		background-color: var(--accent);
		color: white;
		border-radius: 3px;
		font-weight: 500;
		text-transform: capitalize;
		width: fit-content;
	}

	.recent-post-date {
		color: rgb(var(--gray));
	}

	@media (max-width: 960px) {
		.sidebar {
			margin-top: 2em;
		}
	}
</style>
